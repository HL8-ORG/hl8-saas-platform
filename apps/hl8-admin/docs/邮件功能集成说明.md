# 邮件功能集成说明

## 概述

本文档说明前端 `apps/hl8-admin` 如何集成后端 `apps/fastify-api` 的邮件验证功能。

## 功能特性

### 1. 用户注册时自动发送验证邮件

- **后端行为**：用户注册成功后，自动生成 6 位数字验证码并发送验证邮件
- **验证码存储**：验证码存储在 `User` 实体的 `emailVerificationCode` 字段
- **验证码有效期**：10 分钟
- **前端行为**：注册成功后自动跳转到 OTP 验证页面

### 2. 邮箱验证

- **接口**：`POST /api/v1/auth/verify-email`
- **请求参数**：
  ```typescript
  {
    email: string // 用户邮箱
    code: string // 6 位数字验证码
  }
  ```
- **响应格式**：
  ```typescript
  {
    success: true,
    data: {
      message: string;
      user: {
        id: string;
        email: string;
        fullName: string;
        role: string;
        isEmailVerified: boolean;
      }
    }
  }
  ```
- **前端使用**：`authService.verifyEmail()`
- **验证成功后**：跳转到登录页面，提示用户登录

### 3. 重新发送验证邮件

- **接口**：`POST /api/v1/auth/resend-verification`
- **请求参数**：
  ```typescript
  {
    email: string // 用户邮箱
  }
  ```
- **响应格式**：
  ```typescript
  {
    success: true,
    data: {
      message: string;
    }
  }
  ```
- **限流策略**：每分钟最多 3 次请求
- **前端使用**：`authService.resendConfirmationEmail(email)`

## 数据库变更

### User 实体新增字段

```typescript
/**
 * 邮箱验证码
 * 用于验证邮箱的 6 位数字验证码
 */
@Column({ name: 'email_verification_code', type: 'varchar', length: 6, nullable: true })
emailVerificationCode: string | null;

/**
 * 邮箱验证码过期时间
 * 验证码的有效期限，超过此时间后验证码失效
 */
@Column({ name: 'email_verification_expires_at', type: 'timestamp', nullable: true })
emailVerificationExpiresAt: Date | null;
```

## 前端集成点

### 1. 注册流程

**文件**：`apps/hl8-admin/src/features/auth/sign-up/components/sign-up-form.tsx`

- 用户填写注册表单（邮箱、密码、确认密码）
- 提交后调用 `authService.register()`
- 注册成功后跳转到 OTP 验证页面，传递 `email` 参数

### 2. OTP 验证页面

**文件**：`apps/hl8-admin/src/features/auth/otp/components/otp-form.tsx`

- 显示 6 位数字输入框
- 用户输入验证码后调用 `authService.verifyEmail()`
- 验证成功后跳转到登录页面
- 提供"重新发送验证码"按钮，调用 `authService.resendConfirmationEmail()`

### 3. 服务方法

**文件**：`apps/hl8-admin/src/lib/services/auth.service.ts`

#### `verifyEmail()`

```typescript
async verifyEmail(data: ConfirmEmailRequest): Promise<{
  message: string;
  user: {
    id: string;
    email: string;
    fullName: string;
    role: string;
    isEmailVerified: boolean;
  };
}>
```

#### `resendConfirmationEmail()`

```typescript
async resendConfirmationEmail(email: string): Promise<ApiResponse>
```

## 后端接口

### 1. 验证邮箱

**路由**：`POST /api/v1/auth/verify-email`

**限流**：每分钟最多 5 次请求

**验证规则**：

- 验证码必须匹配
- 验证码必须在有效期内（10分钟）
- 用户必须存在且邮箱未验证

**错误响应**：

- `404`：用户不存在
- `401`：验证码错误或已过期
- `409`：邮箱已验证

### 2. 重新发送验证邮件

**路由**：`POST /api/v1/auth/resend-verification`

**限流**：每分钟最多 3 次请求

**验证规则**：

- 用户必须存在
- 用户邮箱必须未验证

**错误响应**：

- `404`：用户不存在
- `409`：邮箱已验证
- `401`：邮件发送失败

## 使用流程

1. **用户注册**
   - 用户填写注册表单
   - 后端创建用户并发送验证邮件
   - 前端跳转到 OTP 验证页面

2. **邮箱验证**
   - 用户输入收到的 6 位验证码
   - 前端调用 `verifyEmail()` 接口
   - 验证成功后跳转到登录页面

3. **重新发送验证码**（可选）
   - 如果用户未收到验证码，可以点击"重新发送验证码"
   - 前端调用 `resendConfirmationEmail()` 接口
   - 后端生成新的验证码并重新发送邮件

4. **用户登录**
   - 验证成功后，用户可以使用邮箱和密码登录
   - 登录后可以访问需要邮箱验证的功能（使用 `VerifiedEmailGuard`）

## 注意事项

1. **验证码有效期**：验证码有效期为 10 分钟，过期后需要重新发送
2. **限流保护**：重新发送验证邮件接口有严格的限流（每分钟 3 次），防止滥用
3. **验证码存储**：验证码存储在数据库中，验证成功后自动清除
4. **邮件发送失败**：如果邮件发送失败，不会影响注册流程，但用户需要重新发送验证邮件
5. **已验证用户**：已验证的用户无法再次验证或重新发送验证邮件

## 测试建议

1. **注册流程测试**
   - 测试正常注册流程
   - 测试重复邮箱注册
   - 测试邮件发送失败的情况

2. **验证流程测试**
   - 测试正确的验证码
   - 测试错误的验证码
   - 测试过期的验证码
   - 测试已验证用户的验证请求

3. **重新发送测试**
   - 测试正常重新发送
   - 测试限流保护
   - 测试已验证用户的重新发送请求

4. **集成测试**
   - 测试完整的注册→验证→登录流程
   - 测试 `VerifiedEmailGuard` 的保护功能
