# 前后端环境配置说明

## 配置匹配检查

### 发现的不匹配问题

#### 1. 端口号不匹配

**后端配置**（`apps/fastify-api`）：

- 默认端口：`8080`（从 `env.validation.ts` 中确认）
- 环境变量：`PORT=8080`（或自定义）

**前端配置**（`apps/hl8-admin`）：

- 默认 API 地址：`http://localhost:9528/api/v1` ❌ **不匹配**
- 应该改为：`http://localhost:8080/api/v1` ✅

**解决方案**：

- 方案 1（推荐）：在前端 `.env` 文件中设置 `VITE_API_BASE_URL=http://localhost:8080/api/v1`
- 方案 2：修改后端 `.env` 文件，设置 `PORT=9528`

#### 2. CORS 配置

**后端配置**（`apps/fastify-api`）：

- 环境变量：`CORS_ORIGIN`（支持多个，用逗号分隔）
- 默认值：`http://localhost:3000`（从 `env.validation.ts` 中确认）
- 代码位置：`src/main.ts` 第 62 行

**前端配置**（`apps/hl8-admin`）：

- Vite 默认端口：`5173`
- 已启用：`withCredentials: true` ✅

**解决方案**：
在后端 `.env` 文件中设置：

```env
CORS_ORIGIN=http://localhost:5173,http://localhost:3000
```

#### 3. README 文档错误

**问题**：`apps/fastify-api/README.md` 中写的是 `ALLOW_CORS_URL`，但实际代码使用的是 `CORS_ORIGIN`

**建议**：更新 README.md，将 `ALLOW_CORS_URL` 改为 `CORS_ORIGIN`

---

## 正确的环境变量配置

### 后端 `.env` 文件（`apps/fastify-api/.env`）

```env
# 服务器配置
HOST=localhost
PORT=8080
NODE_ENV=development

# CORS 配置（重要：必须包含前端地址）
# 支持多个地址，用逗号分隔
CORS_ORIGIN=http://localhost:5173,http://localhost:3000

# JWT 配置
JWT_ACCESS_SECRET=your-access-token-secret-min-32-chars
JWT_ACCESS_EXPIRY=15m
JWT_REFRESH_SECRET=your-refresh-token-secret-min-32-chars
JWT_REFRESH_EXPIRY=7d

# 数据库配置（PostgreSQL）
DATABASE_URL=postgresql://username:password@localhost:5432/hl8-platform
DB_TYPE=postgres

# 日志配置
LOG_LEVEL=info
```

### 前端 `.env` 文件（`apps/hl8-admin/.env`）

```env
# API 基础地址
# 必须与后端 PORT 和全局前缀匹配
# 格式：http://<后端地址>:<后端端口>/api/v1
VITE_API_BASE_URL=http://localhost:8080/api/v1
```

---

## 配置检查清单

### 后端配置检查

- [ ] `PORT` 环境变量已设置（默认 8080）
- [ ] `CORS_ORIGIN` 环境变量已设置，包含前端地址（如 `http://localhost:5173`）
- [ ] `CORS_ORIGIN` 支持多个地址时用逗号分隔
- [ ] JWT 密钥已设置且长度符合要求（至少 32 个字符）

### 前端配置检查

- [ ] `VITE_API_BASE_URL` 环境变量已设置
- [ ] `VITE_API_BASE_URL` 格式正确：`http://localhost:<后端端口>/api/v1`
- [ ] `VITE_API_BASE_URL` 中的端口与后端 `PORT` 匹配
- [ ] `withCredentials: true` 已启用（已在代码中设置）✅

---

## 常见问题

### Q1: 前端无法连接到后端

**检查项**：

1. 后端服务是否已启动？
2. 前端 `VITE_API_BASE_URL` 中的端口是否与后端 `PORT` 匹配？
3. 后端 `CORS_ORIGIN` 是否包含前端地址？

### Q2: CORS 错误

**检查项**：

1. 后端 `CORS_ORIGIN` 是否包含前端完整地址（包括协议、域名、端口）？
2. 前端是否启用了 `withCredentials: true`？（已启用 ✅）
3. 后端是否设置了 `credentials: true`？（已设置 ✅）

### Q3: Cookie 无法传输

**检查项**：

1. 前端 `withCredentials: true` 已启用 ✅
2. 后端 `credentials: true` 已设置 ✅
3. 后端 `CORS_ORIGIN` 不能使用通配符 `*`，必须指定具体地址

---

## 快速配置示例

### 开发环境

**后端**（`apps/fastify-api/.env`）：

```env
PORT=8080
CORS_ORIGIN=http://localhost:5173
```

**前端**（`apps/hl8-admin/.env`）：

```env
VITE_API_BASE_URL=http://localhost:8080/api/v1
```

### 生产环境

**后端**（`apps/fastify-api/.env`）：

```env
PORT=8080
CORS_ORIGIN=https://admin.yourdomain.com
```

**前端**（`apps/hl8-admin/.env`）：

```env
VITE_API_BASE_URL=https://api.yourdomain.com/api/v1
```

---

**最后更新**：2024年  
**维护者**：HL8 开发团队
