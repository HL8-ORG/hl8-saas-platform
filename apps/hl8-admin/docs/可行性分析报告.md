# å‰åç«¯å¯¹æ¥å¯è¡Œæ€§åˆ†ææŠ¥å‘Š

## 1. æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ `apps/hl8-admin`ï¼ˆå‰ç«¯ï¼‰ä¸ `apps/fastify-api`ï¼ˆåç«¯ï¼‰çš„å¯¹æ¥å¯è¡Œæ€§è¿›è¡Œå…¨é¢åˆ†æã€‚ç»è¿‡æŠ€æœ¯æ ˆå…¼å®¹æ€§ã€API æ¥å£å¯¹æ¥ã€æ•°æ®æ ¼å¼åŒ¹é…ã€è®¤è¯æœºåˆ¶ã€å®‰å…¨æ€§ç­‰å¤šç»´åº¦è¯„ä¼°ï¼Œ**æ•´ä½“å¯è¡Œæ€§ä¸ºï¼šä¸­ç­‰åé«˜ï¼ˆ7/10ï¼‰**ã€‚

### æ ¸å¿ƒç»“è®º

âœ… **å¯è¡Œ**ï¼šæŠ€æœ¯æ ˆå…¼å®¹ã€æ¶æ„è®¾è®¡åˆç†ã€æœ‰é€‚é…å™¨å±‚å¤„ç†æ•°æ®è½¬æ¢  
âš ï¸ **éœ€è¦è°ƒæ•´**ï¼šAPI è·¯å¾„ä¸åŒ¹é…ã€æ¥å£å‘½åä¸ä¸€è‡´ã€å“åº”æ ¼å¼éœ€é€‚é…  
âŒ **é£é™©ç‚¹**ï¼šCookie è®¤è¯æœºåˆ¶éœ€è¦åè°ƒã€CORS é…ç½®éœ€å®Œå–„

---

## 2. æŠ€æœ¯æ ˆå…¼å®¹æ€§åˆ†æ

### 2.1 è¯­è¨€ä¸ç±»å‹ç³»ç»Ÿ

| ç»´åº¦     | å‰ç«¯ (hl8-admin)       | åç«¯ (fastify-api) | å…¼å®¹æ€§               |
| -------- | ---------------------- | ------------------ | -------------------- |
| ç¼–ç¨‹è¯­è¨€ | TypeScript 5.9.3       | TypeScript 5.x     | âœ… å®Œå…¨å…¼å®¹          |
| ç±»å‹ç³»ç»Ÿ | ä¸¥æ ¼æ¨¡å¼               | ä¸¥æ ¼æ¨¡å¼           | âœ… å®Œå…¨å…¼å®¹          |
| æ¨¡å—ç³»ç»Ÿ | ESM (`type: "module"`) | CommonJS (NestJS)  | âœ… HTTP é€šä¿¡ï¼Œæ— å½±å“ |

**è¯„ä¼°**ï¼šâœ… å®Œå…¨å…¼å®¹ï¼Œç±»å‹ç³»ç»Ÿä¸€è‡´ï¼Œå¯é€šè¿‡å…±äº«ç±»å‹å®šä¹‰å®ç°ç±»å‹å®‰å…¨ã€‚

### 2.2 æ¡†æ¶ä¸è¿è¡Œæ—¶

| ç»´åº¦        | å‰ç«¯               | åç«¯                  | å…¼å®¹æ€§             |
| ----------- | ------------------ | --------------------- | ------------------ |
| æ ¸å¿ƒæ¡†æ¶    | React 19 + Vite    | NestJS 11 + Fastify   | âœ… å®Œå…¨å…¼å®¹        |
| HTTP å®¢æˆ·ç«¯ | Axios 1.13.2       | Fastify 5.6.2         | âœ… æ ‡å‡† HTTPï¼Œå…¼å®¹ |
| æ•°æ®éªŒè¯    | Zod 4.1.12         | class-validator + Zod | âœ… å…¼å®¹            |
| æ—¥å¿—ç³»ç»Ÿ    | console.log (å¼€å‘) | Pino (ç”Ÿäº§çº§)         | âš ï¸ å»ºè®®ç»Ÿä¸€        |

**è¯„ä¼°**ï¼šâœ… æ¡†æ¶å±‚é¢å®Œå…¨å…¼å®¹ï¼ŒHTTP é€šä¿¡æ ‡å‡†ï¼Œæ— æŠ€æœ¯éšœç¢ã€‚

---

## 3. API æ¥å£å¯¹æ¥åˆ†æ

### 3.1 API è·¯å¾„é…ç½®

#### åç«¯é…ç½®

```typescript
// apps/fastify-api/src/main.ts
app.setGlobalPrefix('api/v1')
// å®é™…è·¯å¾„ï¼š/api/v1/auth/login
```

#### å‰ç«¯é…ç½®

```typescript
// apps/hl8-admin/src/lib/api-client.ts
baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:9528/v1'
// å®é™…è°ƒç”¨ï¼šhttp://localhost:9528/v1/auth/login
```

**é—®é¢˜**ï¼šâŒ **è·¯å¾„ä¸åŒ¹é…**

- åç«¯å®é™…è·¯å¾„ï¼š`/api/v1/auth/login`
- å‰ç«¯è°ƒç”¨è·¯å¾„ï¼š`/v1/auth/login`
- **ç¼ºå°‘ `/api` å‰ç¼€**

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// æ–¹æ¡ˆ 1ï¼šä¿®æ”¹å‰ç«¯ baseURL
baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:9528/api/v1'

// æ–¹æ¡ˆ 2ï¼šä¿®æ”¹åç«¯å…¨å±€å‰ç¼€ï¼ˆä¸æ¨èï¼Œå½±å“å…¶ä»–å®¢æˆ·ç«¯ï¼‰
app.setGlobalPrefix('v1')
```

**ä¼˜å…ˆçº§**ï¼šğŸ”´ **é«˜** - å¿…é¡»ä¿®å¤ï¼Œå¦åˆ™æ‰€æœ‰ API è°ƒç”¨å°†å¤±è´¥ã€‚

### 3.2 æ¥å£è·¯å¾„æ˜ å°„

| åŠŸèƒ½         | åç«¯è·¯å¾„             | å‰ç«¯è°ƒç”¨è·¯å¾„              | çŠ¶æ€      |
| ------------ | -------------------- | ------------------------- | --------- |
| ç”¨æˆ·æ³¨å†Œ     | `POST /auth/signup`  | `POST /auth/register`     | âŒ ä¸åŒ¹é… |
| ç”¨æˆ·ç™»å½•     | `POST /auth/login`   | `POST /auth/login`        | âœ… åŒ¹é…   |
| åˆ·æ–°ä»¤ç‰Œ     | `POST /auth/refresh` | `POST /auth/refreshToken` | âŒ ä¸åŒ¹é… |
| ç”¨æˆ·ç™»å‡º     | `POST /auth/logout`  | `POST /auth/sign-out`     | âŒ ä¸åŒ¹é… |
| è·å–ç”¨æˆ·ä¿¡æ¯ | `GET /auth/me`       | `GET /users/profile`      | âŒ ä¸åŒ¹é… |

**é—®é¢˜åˆ†æ**ï¼š

1. **æ³¨å†Œæ¥å£**ï¼š`signup` vs `register` - è¯­ä¹‰ç›¸åŒï¼Œéœ€ç»Ÿä¸€
2. **åˆ·æ–°ä»¤ç‰Œ**ï¼š`refresh` vs `refreshToken` - éœ€ç»Ÿä¸€
3. **ç™»å‡ºæ¥å£**ï¼š`logout` vs `sign-out` - éœ€ç»Ÿä¸€
4. **ç”¨æˆ·ä¿¡æ¯**ï¼š`/auth/me` vs `/users/profile` - åç«¯æœ‰ä¸¤ä¸ªæ¥å£ï¼Œéœ€ç¡®è®¤ä½¿ç”¨å“ªä¸ª

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// æ–¹æ¡ˆ 1ï¼šä¿®æ”¹å‰ç«¯æœåŠ¡å±‚ï¼ˆæ¨èï¼‰
// apps/hl8-admin/src/lib/services/auth.service.ts
async register() {
  return apiClient.post('/auth/signup', data)  // æ”¹ä¸º signup
}

async refreshToken() {
  return apiClient.post('/auth/refresh', data)  // æ”¹ä¸º refresh
}

async signOut() {
  return apiClient.post('/auth/logout', data)  // æ”¹ä¸º logout
}

// æ–¹æ¡ˆ 2ï¼šä¿®æ”¹åç«¯è·¯ç”±ï¼ˆä¸æ¨èï¼Œå½±å“ API ä¸€è‡´æ€§ï¼‰
```

**ä¼˜å…ˆçº§**ï¼šğŸ”´ **é«˜** - å¿…é¡»ä¿®å¤ï¼Œå¦åˆ™è®¤è¯æµç¨‹æ— æ³•æ­£å¸¸å·¥ä½œã€‚

### 3.3 è¯·æ±‚å‚æ•°æ ¼å¼

#### ç™»å½•è¯·æ±‚

**åç«¯æœŸæœ›**ï¼š

```typescript
// apps/fastify-api/src/modules/auth/dtos/login.dto.ts
{
  identifier: string // é‚®ç®±æˆ–ç”¨æˆ·å
  password: string
}
```

**å‰ç«¯å‘é€**ï¼š

```typescript
// apps/hl8-admin/src/lib/services/auth.service.ts
interface SignInRequest {
  identifier: string
  password: string
}
```

**è¯„ä¼°**ï¼šâœ… **å®Œå…¨åŒ¹é…**

#### åˆ·æ–°ä»¤ç‰Œè¯·æ±‚

**åç«¯æœŸæœ›**ï¼š

```typescript
// ä» Cookie è¯»å– refreshTokenï¼Œæ— éœ€è¯·æ±‚ä½“
// ä½¿ç”¨ RefreshTokenGuard éªŒè¯
```

**å‰ç«¯å‘é€**ï¼š

```typescript
// apps/hl8-admin/src/lib/services/auth.service.ts
interface RefreshTokenRequest {
  refreshToken: string // é€šè¿‡è¯·æ±‚ä½“å‘é€
}
```

**é—®é¢˜**ï¼šâš ï¸ **æœºåˆ¶ä¸ä¸€è‡´**

- åç«¯ï¼šä» Cookie è¯»å– `refreshToken`
- å‰ç«¯ï¼šé€šè¿‡è¯·æ±‚ä½“å‘é€ `refreshToken`

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// æ–¹æ¡ˆ 1ï¼šä¿®æ”¹å‰ç«¯ï¼Œä½¿ç”¨ Cookieï¼ˆæ¨èï¼‰
// åç«¯å·²è®¾ç½® HttpOnly Cookieï¼Œå‰ç«¯æ— éœ€æ‰‹åŠ¨å‘é€
// åªéœ€è°ƒç”¨ POST /auth/refreshï¼Œåç«¯è‡ªåŠ¨ä» Cookie è¯»å–

// æ–¹æ¡ˆ 2ï¼šä¿®æ”¹åç«¯ï¼Œæ”¯æŒè¯·æ±‚ä½“ï¼ˆä¸æ¨èï¼Œé™ä½å®‰å…¨æ€§ï¼‰
```

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **ä¸­** - éœ€è¦åè°ƒï¼Œä½†ä¸å½±å“åŸºæœ¬åŠŸèƒ½ã€‚

---

## 4. å“åº”æ•°æ®æ ¼å¼åˆ†æ

### 4.1 åç«¯å“åº”æ ¼å¼

```typescript
// apps/fastify-api/src/common/interfaces/api-response.interface.ts
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: ApiError;
  meta?: ApiMeta;
}

// æˆåŠŸå“åº”ç¤ºä¾‹
{
  success: true,
  data: { ... },
  meta: {
    correlationId: "...",
    timestamp: "2024-01-01T00:00:00.000Z"
  }
}

// é”™è¯¯å“åº”ç¤ºä¾‹
{
  success: false,
  error: {
    message: "é”™è¯¯æ¶ˆæ¯",
    code: "ERROR_CODE",
    details: { ... }
  },
  meta: {
    correlationId: "..."
  }
}
```

### 4.2 å‰ç«¯æœŸæœ›æ ¼å¼

```typescript
// apps/hl8-admin/src/lib/api-client.ts
// å“åº”æ‹¦æˆªå™¨æå– data å­—æ®µ
if (response.data && 'data' in response.data) {
  return {
    ...response,
    data: response.data.data,  // æå– data å­—æ®µ
  }
}

// å‰ç«¯æœåŠ¡å±‚æœŸæœ›
interface SignInResponse {
  message: string;
  data: SignInResponseData;
  tokens: { ... };
}
```

### 4.3 æ ¼å¼é€‚é…åˆ†æ

**é—®é¢˜**ï¼šâš ï¸ **æ ¼å¼ä¸å®Œå…¨åŒ¹é…**

1. **æˆåŠŸå“åº”**ï¼š
   - åç«¯ï¼š`{ success: true, data: T, meta: {...} }`
   - å‰ç«¯æœŸæœ›ï¼š`{ message: string, data: T }` æˆ– `{ code, message, data }`
   - **å‰ç«¯é€‚é…å™¨å·²å¤„ç†**ï¼šæå– `data` å­—æ®µ âœ…

2. **é”™è¯¯å“åº”**ï¼š
   - åç«¯ï¼š`{ success: false, error: { message, code, details } }`
   - å‰ç«¯å¤„ç†ï¼šé€šè¿‡ `handle-server-error.ts` ç»Ÿä¸€å¤„ç† âœ…

3. **ç™»å½•å“åº”ç‰¹æ®Šå¤„ç†**ï¼š

   ```typescript
   // åç«¯å®é™…è¿”å›ï¼ˆauth.controller.tsï¼‰
   {
     user: { ... },
     accessToken: "...",
     refreshToken: "..."
   }

   // ä½†ä¼šè¢« ResponseInterceptor åŒ…è£…ä¸º
   {
     success: true,
     data: {
       user: { ... },
       accessToken: "...",
       refreshToken: "..."
     },
     meta: { ... }
   }
   ```

   **å‰ç«¯é€‚é…å™¨éœ€è¦è°ƒæ•´**ï¼š

   ```typescript
   // apps/hl8-admin/src/lib/adapters/auth.adapter.ts
   // éœ€è¦é€‚é…æ–°çš„å“åº”æ ¼å¼
   ```

**è¯„ä¼°**ï¼šğŸŸ¡ **éœ€è¦è°ƒæ•´é€‚é…å™¨å±‚**

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ›´æ–°å‰ç«¯é€‚é…å™¨ï¼Œé€‚é…åç«¯ç»Ÿä¸€å“åº”æ ¼å¼
2. æˆ–ä¿®æ”¹åç«¯å“åº”æ‹¦æˆªå™¨ï¼Œå¯¹è®¤è¯æ¥å£ç‰¹æ®Šå¤„ç†ï¼ˆä¸æ¨èï¼‰

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **ä¸­** - æœ‰é€‚é…å™¨å±‚ï¼Œè°ƒæ•´æˆæœ¬è¾ƒä½ã€‚

---

## 5. è®¤è¯æœºåˆ¶åˆ†æ

### 5.1 Token å­˜å‚¨æœºåˆ¶

#### åç«¯å®ç°

```typescript
// apps/fastify-api/src/modules/auth/auth.controller.ts
// ç™»å½•æˆåŠŸåè®¾ç½® HttpOnly Cookie
reply.setCookie(
  COOKIE_CONFIG.ACCESS_TOKEN.name,
  data.accessToken,
  COOKIE_CONFIG.ACCESS_TOKEN.options  // HttpOnly, Secure, SameSite
);
reply.setCookie(
  COOKIE_CONFIG.REFRESH_TOKEN.name,
  data.refreshToken,
  COOKIE_CONFIG.REFRESH_TOKEN.options
);

// åŒæ—¶è¿”å›å“åº”ä½“ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
return {
  user: data.user,
  accessToken: data.accessToken,
  refreshToken: data.refreshToken,
};
```

#### å‰ç«¯å®ç°

```typescript
// apps/hl8-admin/src/stores/auth-store.ts
// ä» Cookie è¯»å– Token
function getTokenFromCookie(key: string): string {
  const token = getCookie(key)
  return token || ''
}

// ä¿å­˜ Token åˆ° Cookie
function setTokenToCookie(key: string, token: string): void {
  setCookie(key, token, 60 * 60 * 24 * 7)
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **åç«¯ä½¿ç”¨ HttpOnly Cookie**ï¼šJavaScript æ— æ³•ç›´æ¥è¯»å–
2. **å‰ç«¯æ‰‹åŠ¨ç®¡ç† Cookie**ï¼šä¸åç«¯æœºåˆ¶å†²çª
3. **Token æ¥æºä¸ä¸€è‡´**ï¼šåç«¯ä» Cookie è¯»å–ï¼Œå‰ç«¯ä»å“åº”ä½“è·å–

**è¯„ä¼°**ï¼šâŒ **æœºåˆ¶å†²çª**

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// æ–¹æ¡ˆ 1ï¼šç»Ÿä¸€ä½¿ç”¨ Cookieï¼ˆæ¨èï¼‰
// åç«¯ï¼šç»§ç»­ä½¿ç”¨ HttpOnly Cookie
// å‰ç«¯ï¼šç§»é™¤æ‰‹åŠ¨ Cookie ç®¡ç†ï¼Œä¾èµ–åç«¯è‡ªåŠ¨å¤„ç†
// ä¿®æ”¹ api-client.tsï¼Œå¯ç”¨ withCredentials
apiClient.defaults.withCredentials = true

// æ–¹æ¡ˆ 2ï¼šç»Ÿä¸€ä½¿ç”¨å“åº”ä½“ï¼ˆä¸æ¨èï¼Œé™ä½å®‰å…¨æ€§ï¼‰
// åç«¯ï¼šç§»é™¤ Cookie è®¾ç½®ï¼Œåªè¿”å›å“åº”ä½“
// å‰ç«¯ï¼šç»§ç»­æ‰‹åŠ¨ç®¡ç† Cookie
```

**ä¼˜å…ˆçº§**ï¼šğŸ”´ **é«˜** - è®¤è¯æœºåˆ¶æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»ç»Ÿä¸€ã€‚

### 5.2 Token åˆ·æ–°æœºåˆ¶

#### åç«¯å®ç°

```typescript
// apps/fastify-api/src/modules/auth/auth.controller.ts
@Post('/refresh')
@UseGuards(RefreshTokenGuard)  // ä» Cookie è¯»å– refreshToken
async refreshToken(@GetUser('sub') userId: string, ...) {
  const rt = req.cookies[COOKIE_CONFIG.REFRESH_TOKEN.name];
  // åˆ·æ–°é€»è¾‘...
  reply.setCookie(ACCESS_TOKEN.name, accessToken, ...);
  reply.setCookie(REFRESH_TOKEN.name, refreshToken, ...);
  return { message: 'Tokens refreshed successfully' };
}
```

#### å‰ç«¯å®ç°

```typescript
// apps/hl8-admin/src/lib/api-client.ts
// å“åº”æ‹¦æˆªå™¨å¤„ç† 401 é”™è¯¯
if (error.response?.status === 401) {
  // è°ƒç”¨åˆ·æ–°ä»¤ç‰Œ API
  const response = await authService.refreshToken({
    refreshToken: refreshToken,  // ä»çŠ¶æ€ä¸­è·å–
  });
  // æ›´æ–° Token
  authState.setTokens({ ... });
  // é‡è¯•åŸå§‹è¯·æ±‚
  return apiClient(originalRequest);
}
```

**é—®é¢˜**ï¼šâš ï¸ **åˆ·æ–°æœºåˆ¶ä¸åŒ¹é…**

- åç«¯ï¼šä» Cookie è‡ªåŠ¨è¯»å–ï¼Œæ— éœ€è¯·æ±‚ä½“
- å‰ç«¯ï¼šé€šè¿‡è¯·æ±‚ä½“å‘é€ refreshToken

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// ä¿®æ”¹å‰ç«¯åˆ·æ–°é€»è¾‘
async refreshToken(): Promise<RefreshTokenResponse> {
  // æ— éœ€è¯·æ±‚ä½“ï¼Œåç«¯è‡ªåŠ¨ä» Cookie è¯»å–
  const response = await apiClient.post<RefreshTokenResponse>(
    '/auth/refresh',
    {},  // ç©ºè¯·æ±‚ä½“
    { skipDataExtraction: true }
  );
  // åç«¯å·²è®¾ç½®æ–° Cookieï¼Œå‰ç«¯åªéœ€æ›´æ–°çŠ¶æ€
  return response.data;
}
```

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **ä¸­** - éœ€è¦è°ƒæ•´ï¼Œä½†ä¸å½±å“åŸºæœ¬åŠŸèƒ½ã€‚

---

## 6. CORS é…ç½®åˆ†æ

### 6.1 åç«¯é…ç½®

```typescript
// apps/fastify-api/src/main.ts
app.enableCors({
  origin: corsOrigins, // ä»ç¯å¢ƒå˜é‡è¯»å–
  credentials: true, // å…è®¸æºå¸¦å‡­è¯ï¼ˆCookieï¼‰
})
```

### 6.2 å‰ç«¯é…ç½®

```typescript
// apps/hl8-admin/src/lib/api-client.ts
const apiClient = axios.create({
  baseURL: '...',
  withCredentials: false, // âŒ æš‚æ—¶ç¦ç”¨
  // ...
})
```

**é—®é¢˜**ï¼šâŒ **CORS é…ç½®ä¸åŒ¹é…**

- åç«¯ï¼šå…è®¸æºå¸¦å‡­è¯ï¼ˆ`credentials: true`ï¼‰
- å‰ç«¯ï¼šç¦ç”¨å‡­è¯ï¼ˆ`withCredentials: false`ï¼‰
- **ç»“æœ**ï¼šCookie æ— æ³•æ­£å¸¸ä¼ è¾“

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// ä¿®æ”¹å‰ç«¯é…ç½®
const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:9528/api/v1',
  withCredentials: true, // âœ… å¯ç”¨å‡­è¯
  // ...
})
```

**ç¯å¢ƒå˜é‡é…ç½®**ï¼š

```env
# åç«¯ .env
CORS_ORIGIN=http://localhost:5173,http://localhost:3000

# å‰ç«¯ .env
VITE_API_BASE_URL=http://localhost:9528/api/v1
```

**ä¼˜å…ˆçº§**ï¼šğŸ”´ **é«˜** - å¿…é¡»ä¿®å¤ï¼Œå¦åˆ™ Cookie è®¤è¯æ— æ³•å·¥ä½œã€‚

---

## 7. é”™è¯¯å¤„ç†åˆ†æ

### 7.1 åç«¯é”™è¯¯å¤„ç†

```typescript
// apps/fastify-api/src/common/filters/http-exception.filter.ts
// ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
{
  success: false,
  error: {
    message: "é”™è¯¯æ¶ˆæ¯",
    code: "ERROR_CODE",
    details: { ... }
  },
  meta: {
    correlationId: "..."
  }
}
```

### 7.2 å‰ç«¯é”™è¯¯å¤„ç†

```typescript
// apps/hl8-admin/src/lib/handle-server-error.ts
// ç»Ÿä¸€å¤„ç†æœåŠ¡å™¨é”™è¯¯
export function handleServerError(error: AxiosError) {
  if (error.response) {
    const errorData = error.response.data
    // å¤„ç†é”™è¯¯æ¶ˆæ¯
  }
}
```

**è¯„ä¼°**ï¼šâœ… **åŸºæœ¬å…¼å®¹**

- å‰ç«¯æœ‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- éœ€è¦é€‚é…åç«¯æ–°çš„é”™è¯¯æ ¼å¼ï¼ˆ`error.code`, `error.details`ï¼‰

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ **ä½** - å·²æœ‰é”™è¯¯å¤„ç†ï¼Œåªéœ€å¾®è°ƒã€‚

---

## 8. æ•°æ®éªŒè¯åˆ†æ

### 8.1 åç«¯éªŒè¯

```typescript
// apps/fastify-api
// ä½¿ç”¨ class-validator + Zod
@Post('/login')
async login(@Body() loginDto: LoginDto) {
  // ValidationPipe è‡ªåŠ¨éªŒè¯
}
```

### 8.2 å‰ç«¯éªŒè¯

```typescript
// apps/hl8-admin
// ä½¿ç”¨ Zod + React Hook Form
const schema = z.object({
  identifier: z.string().email(),
  password: z.string().min(8),
})
```

**è¯„ä¼°**ï¼šâœ… **å®Œå…¨å…¼å®¹**

- å‰åç«¯éƒ½ä½¿ç”¨ Zodï¼Œå¯ä»¥å…±äº« Schema å®šä¹‰
- å‰ç«¯éªŒè¯å¯ä»¥é˜²æ­¢æ— æ•ˆè¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ **ä½** - å·²å®ç°ï¼Œæ— éœ€è°ƒæ•´ã€‚

---

## 9. é£é™©è¯„ä¼°

### 9.1 é«˜é£é™©é¡¹

| é£é™©é¡¹              | å½±å“  | æ¦‚ç‡ | ç¼“è§£æªæ–½                    |
| ------------------- | ----- | ---- | --------------------------- |
| API è·¯å¾„ä¸åŒ¹é…      | ğŸ”´ é«˜ | 100% | ä¿®æ”¹å‰ç«¯ baseURL æˆ–åç«¯å‰ç¼€ |
| æ¥å£è·¯å¾„ä¸ä¸€è‡´      | ğŸ”´ é«˜ | 100% | ç»Ÿä¸€æ¥å£å‘½åè§„èŒƒ            |
| Cookie è®¤è¯æœºåˆ¶å†²çª | ğŸ”´ é«˜ | 100% | ç»Ÿä¸€ä½¿ç”¨ HttpOnly Cookie    |
| CORS é…ç½®é”™è¯¯       | ğŸ”´ é«˜ | 100% | å¯ç”¨ withCredentials        |

### 9.2 ä¸­é£é™©é¡¹

| é£é™©é¡¹               | å½±å“  | æ¦‚ç‡ | ç¼“è§£æªæ–½     |
| -------------------- | ----- | ---- | ------------ |
| å“åº”æ ¼å¼ä¸åŒ¹é…       | ğŸŸ¡ ä¸­ | 80%  | è°ƒæ•´é€‚é…å™¨å±‚ |
| Token åˆ·æ–°æœºåˆ¶ä¸ä¸€è‡´ | ğŸŸ¡ ä¸­ | 80%  | ç»Ÿä¸€åˆ·æ–°é€»è¾‘ |
| é”™è¯¯æ ¼å¼é€‚é…         | ğŸŸ¡ ä¸­ | 60%  | æ›´æ–°é”™è¯¯å¤„ç† |

### 9.3 ä½é£é™©é¡¹

| é£é™©é¡¹         | å½±å“  | æ¦‚ç‡ | ç¼“è§£æªæ–½        |
| -------------- | ----- | ---- | --------------- |
| æ•°æ®éªŒè¯å·®å¼‚   | ğŸŸ¢ ä½ | 30%  | å…±äº« Zod Schema |
| æ—¥å¿—ç³»ç»Ÿä¸ä¸€è‡´ | ğŸŸ¢ ä½ | 50%  | ç»Ÿä¸€æ—¥å¿—æ ¼å¼    |

---

## 10. å®æ–½å»ºè®®

### 10.1 ä¼˜å…ˆçº§æ’åº

#### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒä¿®å¤ï¼ˆå¿…é¡»å®Œæˆï¼‰

1. âœ… ä¿®å¤ API è·¯å¾„é…ç½®
   - ä¿®æ”¹å‰ç«¯ `baseURL` ä¸º `http://localhost:9528/api/v1`
   - æˆ–ä¿®æ”¹åç«¯å…¨å±€å‰ç¼€ï¼ˆä¸æ¨èï¼‰

2. âœ… ç»Ÿä¸€æ¥å£è·¯å¾„
   - ä¿®æ”¹å‰ç«¯æœåŠ¡å±‚ï¼š`register` â†’ `signup`
   - ä¿®æ”¹å‰ç«¯æœåŠ¡å±‚ï¼š`refreshToken` â†’ `refresh`
   - ä¿®æ”¹å‰ç«¯æœåŠ¡å±‚ï¼š`sign-out` â†’ `logout`

3. âœ… ä¿®å¤ CORS é…ç½®
   - å‰ç«¯å¯ç”¨ `withCredentials: true`
   - åç«¯é…ç½®æ­£ç¡®çš„ `CORS_ORIGIN`

4. âœ… ç»Ÿä¸€è®¤è¯æœºåˆ¶
   - ç§»é™¤å‰ç«¯æ‰‹åŠ¨ Cookie ç®¡ç†
   - ä¾èµ–åç«¯ HttpOnly Cookie
   - æ›´æ–° Token åˆ·æ–°é€»è¾‘

#### ç¬¬äºŒé˜¶æ®µï¼šé€‚é…ä¼˜åŒ–ï¼ˆå»ºè®®å®Œæˆï¼‰

5. âš ï¸ è°ƒæ•´å“åº”æ ¼å¼é€‚é…å™¨
   - æ›´æ–° `auth.adapter.ts` é€‚é…æ–°æ ¼å¼
   - æ›´æ–°å…¶ä»–é€‚é…å™¨ï¼ˆå¦‚éœ€è¦ï¼‰

6. âš ï¸ å®Œå–„é”™è¯¯å¤„ç†
   - é€‚é…åç«¯é”™è¯¯æ ¼å¼ï¼ˆ`error.code`, `error.details`ï¼‰
   - æ›´æ–°é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º

#### ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å¢å¼ºï¼ˆå¯é€‰ï¼‰

7. ğŸ”µ å…±äº«ç±»å‹å®šä¹‰
   - åˆ›å»ºå…±äº«ç±»å‹åŒ…ï¼ˆ`@hl8/types`ï¼‰
   - å‰åç«¯å…±äº«æ¥å£å®šä¹‰

8. ğŸ”µ ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
   - å‰ç«¯å¼•å…¥æ—¥å¿—åº“ï¼ˆå¦‚ `pino`ï¼‰
   - ç»Ÿä¸€æ—¥å¿—æ ¼å¼

### 10.2 å®æ–½æ­¥éª¤

```mermaid
graph TD
    A[å¼€å§‹] --> B[ä¿®å¤ API è·¯å¾„]
    B --> C[ç»Ÿä¸€æ¥å£è·¯å¾„]
    C --> D[ä¿®å¤ CORS é…ç½®]
    D --> E[ç»Ÿä¸€è®¤è¯æœºåˆ¶]
    E --> F[è°ƒæ•´å“åº”é€‚é…å™¨]
    F --> G[å®Œå–„é”™è¯¯å¤„ç†]
    G --> H[æµ‹è¯•éªŒè¯]
    H --> I[å®Œæˆ]
```

### 10.3 æµ‹è¯•éªŒè¯æ¸…å•

- [ ] API è·¯å¾„æ­£ç¡®ï¼Œæ‰€æœ‰è¯·æ±‚èƒ½åˆ°è¾¾åç«¯
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸ï¼ŒToken æ­£ç¡®å­˜å‚¨
- [ ] Token åˆ·æ–°æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] ç™»å‡ºåŠŸèƒ½æ­£å¸¸ï¼ŒCookie æ­£ç¡®æ¸…é™¤
- [ ] é”™è¯¯å“åº”æ­£ç¡®æ˜¾ç¤º
- [ ] CORS é…ç½®æ­£ç¡®ï¼Œæ— è·¨åŸŸé—®é¢˜
- [ ] è®¤è¯å®ˆå«æ­£å¸¸å·¥ä½œï¼Œæœªæˆæƒè¯·æ±‚è¢«æ‹¦æˆª

---

## 11. ç»“è®º

### 11.1 å¯è¡Œæ€§è¯„ä¼°

**æ€»ä½“å¯è¡Œæ€§ï¼š7/10ï¼ˆä¸­ç­‰åé«˜ï¼‰**

| ç»´åº¦         | è¯„åˆ†  | è¯´æ˜                   |
| ------------ | ----- | ---------------------- |
| æŠ€æœ¯æ ˆå…¼å®¹æ€§ | 10/10 | å®Œå…¨å…¼å®¹ï¼Œæ— æŠ€æœ¯éšœç¢   |
| API æ¥å£å¯¹æ¥ | 6/10  | è·¯å¾„ä¸åŒ¹é…ï¼Œéœ€è°ƒæ•´     |
| æ•°æ®æ ¼å¼åŒ¹é… | 7/10  | æœ‰é€‚é…å™¨å±‚ï¼Œéœ€å¾®è°ƒ     |
| è®¤è¯æœºåˆ¶     | 5/10  | æœºåˆ¶å†²çªï¼Œéœ€ç»Ÿä¸€       |
| å®‰å…¨æ€§       | 8/10  | åç«¯å®‰å…¨é…ç½®å®Œå–„       |
| å¯ç»´æŠ¤æ€§     | 8/10  | ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´ |

### 11.2 æœ€ç»ˆå»ºè®®

âœ… **å»ºè®®å®æ–½**ï¼Œä½†éœ€è¦å®Œæˆä»¥ä¸‹ä¿®å¤ï¼š

1. **å¿…é¡»ä¿®å¤**ï¼ˆé˜»å¡æ€§é—®é¢˜ï¼‰ï¼š
   - API è·¯å¾„é…ç½®
   - æ¥å£è·¯å¾„ç»Ÿä¸€
   - CORS é…ç½®
   - è®¤è¯æœºåˆ¶ç»Ÿä¸€

2. **å»ºè®®ä¿®å¤**ï¼ˆå½±å“ä½“éªŒï¼‰ï¼š
   - å“åº”æ ¼å¼é€‚é…
   - é”™è¯¯å¤„ç†å®Œå–„

3. **å¯é€‰ä¼˜åŒ–**ï¼ˆæå‡è´¨é‡ï¼‰ï¼š
   - å…±äº«ç±»å‹å®šä¹‰
   - ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ

### 11.3 é¢„è®¡å·¥ä½œé‡

- **æ ¸å¿ƒä¿®å¤**ï¼š2-3 ä¸ªå·¥ä½œæ—¥
- **é€‚é…ä¼˜åŒ–**ï¼š1-2 ä¸ªå·¥ä½œæ—¥
- **æµ‹è¯•éªŒè¯**ï¼š1 ä¸ªå·¥ä½œæ—¥
- **æ€»è®¡**ï¼š4-6 ä¸ªå·¥ä½œæ—¥

### 11.4 é£é™©æç¤º

âš ï¸ **ä¸»è¦é£é™©**ï¼š

1. Cookie è®¤è¯æœºåˆ¶éœ€è¦å‰åç«¯åè°ƒï¼Œå¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
2. å“åº”æ ¼å¼å˜åŒ–å¯èƒ½å½±å“å…¶ä»–ä¾èµ–è¯¥æ ¼å¼çš„ä»£ç 
3. æ¥å£è·¯å¾„ä¿®æ”¹éœ€è¦å…¨é¢æµ‹è¯•ï¼Œç¡®ä¿æ— é—æ¼

âœ… **é£é™©å¯æ§**ï¼š

- æœ‰é€‚é…å™¨å±‚ï¼Œè°ƒæ•´æˆæœ¬è¾ƒä½
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œä¿®æ”¹å½±å“èŒƒå›´å¯æ§
- æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶

---

## 12. é™„å½•

### 12.1 ç›¸å…³æ–‡ä»¶æ¸…å•

**å‰ç«¯å…³é”®æ–‡ä»¶**ï¼š

- `apps/hl8-admin/src/lib/api-client.ts` - API å®¢æˆ·ç«¯é…ç½®
- `apps/hl8-admin/src/lib/services/auth.service.ts` - è®¤è¯æœåŠ¡
- `apps/hl8-admin/src/lib/adapters/auth.adapter.ts` - è®¤è¯é€‚é…å™¨
- `apps/hl8-admin/src/stores/auth-store.ts` - è®¤è¯çŠ¶æ€ç®¡ç†

**åç«¯å…³é”®æ–‡ä»¶**ï¼š

- `apps/fastify-api/src/main.ts` - åº”ç”¨å¯åŠ¨é…ç½®
- `apps/fastify-api/src/modules/auth/auth.controller.ts` - è®¤è¯æ§åˆ¶å™¨
- `apps/fastify-api/src/common/interceptors/response.interceptor.ts` - å“åº”æ‹¦æˆªå™¨
- `apps/fastify-api/src/common/filters/http-exception.filter.ts` - å¼‚å¸¸è¿‡æ»¤å™¨

### 12.2 ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹

**åç«¯ `.env`**ï¼š

```env
PORT=9528
CORS_ORIGIN=http://localhost:5173,http://localhost:3000
ACCESS_TOKEN_SECRET=your-secret-min-10-chars
REFRESH_TOKEN_SECRET=your-secret-min-10-chars
ACCESS_TOKEN_EXPIRATION=15m
REFRESH_TOKEN_EXPIRATION=7d
```

**å‰ç«¯ `.env`**ï¼š

```env
VITE_API_BASE_URL=http://localhost:9528/api/v1
```

### 12.3 å‚è€ƒæ–‡æ¡£

- [NestJS æ–‡æ¡£](https://docs.nestjs.com/)
- [Fastify æ–‡æ¡£](https://www.fastify.io/)
- [TanStack Query æ–‡æ¡£](https://tanstack.com/query/latest)
- [Axios æ–‡æ¡£](https://axios-http.com/)

---

**æŠ¥å‘Šç‰ˆæœ¬**ï¼š1.0.0  
**ç”Ÿæˆæ—¶é—´**ï¼š2024å¹´  
**åˆ†æäººå‘˜**ï¼šAI Assistant  
**å®¡æ ¸çŠ¶æ€**ï¼šå¾…å®¡æ ¸
