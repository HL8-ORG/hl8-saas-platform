---
name: admin-api架构重构执行计划
overview: 将 apps/admin-api 从传统三层架构重构为 DDD + Clean Architecture + CQRS + EDA 混合架构，采用渐进式重构策略，分4个阶段执行，直接替换现有代码。
todos:
  - id: stage1-deps
    content: 阶段1.1：安装 @nestjs/cqrs 依赖包
    status: completed
  - id: stage1-structure
    content: 阶段1.2：创建 Clean Architecture 目录结构（presentation、application、domain、infrastructure）
    status: completed
  - id: stage1-interfaces
    content: 阶段1.3：实现核心接口和基类（UseCase接口、DomainEvent基类、Repository接口、EventBus）
    status: completed
  - id: stage1-module
    content: 阶段1.4：配置 NestJS 模块，集成 CQRS 和事件总线
    status: completed
  - id: stage2-auth-domain
    content: 阶段2.1：重构认证领域层（值对象、聚合根、领域事件、仓储接口）
    status: completed
  - id: stage2-auth-application
    content: 阶段2.2：重构认证应用层（用例、DTO）
    status: completed
  - id: stage2-auth-infrastructure
    content: 阶段2.3：重构认证基础设施层（仓储实现、ORM映射、事件处理器）
    status: completed
  - id: stage2-auth-presentation
    content: 阶段2.4：重构认证表现层（控制器、HTTP DTO、映射器）
    status: completed
  - id: stage2-users-domain
    content: 阶段2.5：重构用户领域层
    status: completed
  - id: stage2-users-application
    content: 阶段2.6：重构用户应用层
    status: completed
  - id: stage2-users-infrastructure
    content: 阶段2.7：重构用户基础设施层
    status: completed
  - id: stage2-users-presentation
    content: 阶段2.8：重构用户表现层
    status: completed
  - id: stage3-roles
    content: 阶段3.1：重构角色领域（领域层、应用层、基础设施层、表现层）
    status: completed
  - id: stage3-permissions
    content: 阶段3.2：重构权限领域
    status: completed
  - id: stage3-tenants
    content: 阶段3.3：重构租户领域
    status: completed
  - id: stage4-optimization
    content: 阶段4.1：性能优化（查询优化、缓存策略）
    status: completed
  - id: stage4-testing
    content: 阶段4.2：完善测试覆盖（单元测试、集成测试、端到端测试）
    status: in_progress
  - id: stage4-docs
    content: 阶段4.3：更新文档（API文档、架构文档、开发指南）
    status: in_progress
---

# apps/admin-api 架构重构执行计划

## 阶段1：基础设施准备（1-2周）

### 1.1 安装依赖

- 安装 `@nestjs/cqrs` 用于 CQRS 支持
- 确认现有依赖（TypeORM、Fastify、Redis 等）已就绪

### 1.2 创建 Clean Architecture 目录结构

在 `apps/admin-api/src/` 下创建新目录结构：

```
src/
├── presentation/          # 表现层
│   ├── controllers/
│   ├── dtos/
│   └── mappers/
├── application/           # 应用层（用例层）
│   ├── auth/
│   │   ├── use-cases/
│   │   ├── commands/
│   │   ├── queries/
│   │   └── dtos/
│   ├── users/
│   └── shared/
│       ├── interfaces/
│       └── events/
├── domain/               # 领域层
│   ├── auth/
│   │   ├── entities/
│   │   ├── value-objects/
│   │   ├── services/
│   │   ├── events/
│   │   └── repositories/
│   ├── users/
│   ├── roles/
│   ├── permissions/
│   ├── tenants/
│   └── shared/
│       ├── events/
│       └── value-objects/
└── infrastructure/        # 基础设施层
    ├── persistence/
    │   ├── typeorm/
    │   │   ├── repositories/
    │   │   └── entities/
    │   └── mappers/
    ├── events/
    │   ├── event-bus.ts
    │   └── handlers/
    └── external/
```

### 1.3 实现核心基础设施

- **事件总线**：`infrastructure/events/event-bus.ts` - 基于 @nestjs/cqrs EventBus
- **用例接口**：`application/shared/interfaces/use-case.interface.ts`
- **领域事件基类**：`domain/shared/events/domain-event.base.ts`
- **仓储接口基类**：`domain/shared/repositories/repository.interface.ts`

### 1.4 配置 NestJS 模块

- 更新 `app.module.ts` 集成 CQRS 模块
- 配置事件总线模块
- 保持现有中间件和守卫配置

## 阶段2：核心领域重构（3-4周）

### 2.1 认证领域（Auth）重构

#### 领域层

- **值对象**：
  - `domain/auth/value-objects/email.vo.ts` - 邮箱值对象（充血模型）
  - `domain/auth/value-objects/password-hash.vo.ts` - 密码哈希值对象
  - `domain/auth/value-objects/user-id.vo.ts` - 用户ID值对象
  - `domain/auth/value-objects/tenant-id.vo.ts` - 租户ID值对象
  - `domain/auth/value-objects/verification-code.vo.ts` - 验证码值对象

- **聚合根**：
  - `domain/auth/entities/user.aggregate.ts` - 用户聚合根（充血模型）
    - 业务方法：`create()`, `verifyEmail()`, `resendVerificationCode()`, `changePassword()`, `deactivate()`, `activate()`, `updateProfile()`
    - 领域事件：`UserRegisteredEvent`, `EmailVerifiedEvent`, `PasswordChangedEvent` 等

- **领域事件**：
  - `domain/auth/events/user-registered.event.ts`
  - `domain/auth/events/email-verified.event.ts`
  - `domain/auth/events/password-changed.event.ts`
  - `domain/auth/events/user-deactivated.event.ts`
  - `domain/auth/events/user-activated.event.ts`
  - `domain/auth/events/profile-updated.event.ts`
  - `domain/auth/events/verification-code-resent.event.ts`

- **仓储接口**：
  - `domain/auth/repositories/user.repository.interface.ts`

#### 应用层

- **用例**：
  - `application/auth/use-cases/signup.use-case.ts` - 用户注册用例
  - `application/auth/use-cases/login.use-case.ts` - 用户登录用例
  - `application/auth/use-cases/refresh-token.use-case.ts` - 刷新令牌用例
  - `application/auth/use-cases/logout.use-case.ts` - 用户登出用例
  - `application/auth/use-cases/verify-email.use-case.ts` - 验证邮箱用例
  - `application/auth/use-cases/resend-verification.use-case.ts` - 重发验证码用例
  - `application/auth/use-cases/get-me.use-case.ts` - 获取当前用户用例

- **DTO**：
  - `application/auth/dtos/signup.input.dto.ts`
  - `application/auth/dtos/signup.output.dto.ts`
  - 其他用例的输入/输出 DTO

#### 基础设施层

- **仓储实现**：
  - `infrastructure/persistence/typeorm/repositories/user.repository.ts` - 实现 `IUserRepository`
  - `infrastructure/persistence/typeorm/entities/user.entity.ts` - ORM 实体（仅用于映射）
  - `infrastructure/persistence/mappers/user.mapper.ts` - Domain ↔ ORM 映射

- **事件处理器**：
  - `infrastructure/events/handlers/user-registered-email.handler.ts` - 发送验证邮件
  - `infrastructure/events/handlers/user-registered-audit.handler.ts` - 记录审计日志

#### 表现层

- **控制器**：
  - `presentation/controllers/auth/auth.controller.ts` - 重构现有控制器，调用用例
- **DTO**：
  - `presentation/dtos/auth/signup.dto.ts` - HTTP 请求 DTO
- **映射器**：
  - `presentation/mappers/auth.mapper.ts` - HTTP DTO ↔ 用例 Input/Output

### 2.2 用户领域（Users）重构

#### 领域层

- **聚合根**：
  - `domain/users/entities/user-profile.aggregate.ts` - 用户资料聚合根（充血模型）

- **领域事件**：
  - `domain/users/events/user-updated.event.ts`
  - `domain/users/events/user-deleted.event.ts`

- **仓储接口**：
  - `domain/users/repositories/user-profile.repository.interface.ts`
  - `domain/users/repositories/user-read.repository.interface.ts` - 只读仓储（CQRS）

#### 应用层

- **用例**：
  - `application/users/use-cases/get-users.use-case.ts` - 获取用户列表（查询）
  - `application/users/use-cases/get-user-by-id.use-case.ts` - 获取用户详情（查询）
  - `application/users/use-cases/update-user.use-case.ts` - 更新用户（命令）
  - `application/users/use-cases/delete-user.use-case.ts` - 删除用户（命令）
  - `application/users/use-cases/get-profile.use-case.ts` - 获取个人资料（查询）
  - `application/users/use-cases/update-profile.use-case.ts` - 更新个人资料（命令）

#### 基础设施层

- **仓储实现**：
  - `infrastructure/persistence/typeorm/repositories/user-profile.repository.ts`
  - `infrastructure/persistence/typeorm/repositories/user-read.repository.ts` - 只读仓储实现（优化查询）

#### 表现层

- **控制器**：
  - `presentation/controllers/users/users.controller.ts` - 重构现有控制器

## 阶段3：扩展领域重构（2-3周）

### 3.1 角色领域（Roles）重构

- 领域层：角色聚合根、值对象、领域事件
- 应用层：角色管理用例（创建、删除、分配、撤销权限）
- 基础设施层：角色仓储实现
- 表现层：角色控制器重构

### 3.2 权限领域（Permissions）重构

- 领域层：权限聚合根、领域事件
- 应用层：权限查询用例
- 基础设施层：权限仓储实现
- 表现层：权限控制器重构

### 3.3 租户领域（Tenants）重构

- 领域层：租户聚合根、领域事件
- 应用层：租户管理用例
- 基础设施层：租户仓储实现
- 表现层：租户控制器重构

## 阶段4：优化和测试（1-2周）

### 4.1 性能优化

- 查询优化（使用只读仓储、索引优化）
- 缓存策略（Redis 缓存查询结果）
- 事件处理优化

### 4.2 测试覆盖

- 聚合根单元测试（领域逻辑）
- 用例单元测试（应用逻辑）
- 值对象单元测试
- 事件处理器测试
- 控制器集成测试
- 端到端测试

### 4.3 文档更新

- 更新 API 文档
- 更新架构文档
- 更新开发指南

## 关键文件修改清单

### 必须创建的新文件

1. `src/application/shared/interfaces/use-case.interface.ts`
2. `src/domain/shared/events/domain-event.base.ts`
3. `src/infrastructure/events/event-bus.ts`
4. 所有领域层的聚合根、值对象、事件
5. 所有应用层的用例
6. 所有基础设施层的仓储实现和映射器

### 需要重构的现有文件

1. `src/app.module.ts` - 集成 CQRS 模块
2. `src/modules/auth/auth.controller.ts` → `src/presentation/controllers/auth/auth.controller.ts`
3. `src/modules/auth/auth.service.ts` → 拆分为用例和领域逻辑
4. `src/modules/users/users.controller.ts` → `src/presentation/controllers/users/users.controller.ts`
5. `src/modules/users/users.service.ts` → 拆分为用例和领域逻辑
6. 其他模块的控制器和服务

### 需要删除的旧文件

- `src/modules/auth/auth.service.ts`（重构后）
- `src/modules/users/users.service.ts`（重构后）
- 其他旧的服务文件（重构后）

## 注意事项

1. **充血模型**：所有领域实体必须包含业务逻辑，禁止贫血模型
2. **依赖倒置**：领域层不依赖基础设施层，通过接口抽象
3. **事件驱动**：使用领域事件解耦模块，支持异步处理
4. **CQRS**：读操作和写操作分离，使用不同的仓储
5. **测试优先**：每个组件都要有对应的单元测试
6. **渐进式迁移**：保持现有功能可用，逐步替换
