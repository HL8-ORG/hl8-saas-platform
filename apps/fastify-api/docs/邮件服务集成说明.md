# 邮件服务集成说明

## 概述

已成功将 `@hl8/mail` 模块集成到 `apps/fastify-api`，并添加了邮箱验证守卫 `VerifiedEmailGuard`。

## 已完成的工作

### 1. 数据库实体更新

在 `User` 实体中添加了 `isEmailVerified` 字段：

```typescript
@Column({ name: 'is_email_verified', default: false })
isEmailVerified: boolean;
```

### 2. 环境变量配置

在 `env.validation.ts` 中添加了邮件相关配置：

```typescript
MAIL_HOST: z.string().min(1, 'MAIL_HOST is required'),
MAIL_PORT: z.coerce.number().default(587),
MAIL_USERNAME: z.string().min(1, 'MAIL_USERNAME is required'),
MAIL_PASSWORD: z.string().min(1, 'MAIL_PASSWORD is required'),
MAIL_SECURE: z.union([z.boolean(), z.literal('true'), z.literal('false')]).default(false),
APP_NAME: z.string().optional(),
APP_URL: z.string().url().optional(),
```

### 3. 邮件配置服务

创建了 `MailConfigService`（`src/config/mail.config.ts`），实现 `MailConfig` 接口。

### 4. Mailer 配置模块

创建了 `MailerConfigModule`（`src/config/mailer.config.ts`），配置 `@nestjs-modules/mailer`。

### 5. 模块集成

在 `AppModule` 中集成了：

- `MailerConfigModule`：配置邮件发送服务
- `MailModule.forRoot(MailConfigService)`：注册邮件模块
- `TypeOrmModule.forFeature([User])`：为守卫提供 User 实体访问

### 6. 邮箱验证守卫

创建了 `VerifiedEmailGuard`（`src/common/guards/verified-email.guard.ts`），用于保护需要已验证邮箱的端点。

### 7. 认证服务集成

在 `AuthService.signup()` 方法中：

- 新用户默认 `isEmailVerified: false`
- 自动生成 6 位验证码
- 发送验证邮件（使用 `RegisterSuccessMail` 模板）

## 使用方法

### 1. 环境变量配置

在 `.env` 文件中添加：

```env
# 邮件服务配置
MAIL_HOST=smtp.example.com
MAIL_PORT=587
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=your-email-password
MAIL_SECURE=false

# 应用信息（可选）
APP_NAME=HL8 Platform
APP_URL=https://your-domain.com
```

### 2. 使用邮箱验证守卫

在需要已验证邮箱的端点使用守卫：

```typescript
import { UseGuards } from '@nestjs/common';
import { AuthGuard } from '../../common/guards/auth.guard';
import { VerifiedEmailGuard } from '../../common/guards/verified-email.guard';

@Controller('users')
export class UsersController {
  @UseGuards(AuthGuard, VerifiedEmailGuard)
  @Patch('/update-password')
  async updatePassword() {
    // 只有已验证邮箱的用户才能访问
  }
}
```

### 3. 发送验证邮件

在 `AuthService` 中，注册时会自动发送验证邮件。如果需要手动发送：

```typescript
import { MailService, RegisterSuccessMail } from '@hl8/mail';

constructor(private mailService: MailService) {}

async sendVerificationEmail(user: User, code: string) {
  const appName = this.config.get<string>('APP_NAME') || 'HL8 Platform';
  const appUrl = this.config.get<string>('APP_URL') || 'https://example.com';

  const emailHtml = RegisterSuccessMail({
    name: user.fullName,
    otp: code,
    appName,
    appUrl,
  });

  await this.mailService.sendEmail({
    to: [user.email],
    subject: `欢迎注册 ${appName} - 请验证您的邮箱`,
    html: emailHtml,
  });
}
```

## 守卫工作原理

`VerifiedEmailGuard` 的工作流程：

1. 从请求中获取用户信息（由 `AuthGuard` 设置）
2. 从 JWT 载荷中提取用户 ID（`sub` 字段）
3. 从数据库查询用户信息
4. 检查 `isEmailVerified` 字段
5. 如果未验证，抛出 `UnauthorizedException`

## 注意事项

1. **数据库迁移**：如果数据库已存在，需要手动添加 `is_email_verified` 字段，或使用数据库迁移工具。

2. **验证码存储**：当前实现中，验证码仅在邮件中发送，未存储在数据库中。如果需要验证验证码，需要：
   - 在 User 实体中添加验证码字段
   - 设置验证码过期时间
   - 创建验证端点

3. **邮件发送失败**：如果邮件发送失败，不会影响注册流程，只会记录错误日志。

4. **守卫顺序**：使用 `VerifiedEmailGuard` 时，必须先使用 `AuthGuard`，因为需要从请求中获取用户信息。

## 后续改进建议

1. **验证码验证端点**：创建 `/auth/verify-email` 端点，用于验证邮箱验证码。

2. **验证码存储**：在数据库中存储验证码和过期时间。

3. **重新发送验证邮件**：创建 `/auth/resend-verification` 端点。

4. **JWT 载荷增强**：在 JWT 载荷中包含 `isEmailVerified` 字段，减少数据库查询。

---

**创建日期**：2024-12-06  
**维护者**：HL8 开发团队
