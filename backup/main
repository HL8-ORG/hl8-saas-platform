import { AppModule } from '@/app.module';

import { Module } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import {
  FastifyAdapter,
  NestFastifyApplication,
} from '@nestjs/platform-fastify';

import { Logger, LoggerModule } from '@hl8/logger';
import { ConfigService } from '@nestjs/config';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';


/**
 * 创建自定义日志 Logger 实例。
 *
 * @description
 * 通过临时 Nest 模块初始化日志模块，并关闭 native logger，
 * 以便在应用外部提前创建可注入的 Logger 实例（用于主应用 logger delegate）。
 * 此函数用于主应用初始化时作为 logger 提供自定义日志输出能力。
 * 为什么要这么做：https://dev.to/micalevisk/nestjs-tip-how-to-always-use-your-custom-logger-4fmd
 *
 * @returns {Promise<Logger>} 已初始化的 Logger 实例。
 * @throws 初始化模块或获取 Logger 实例过程中的任何异常。
 * @注意
 * 1. TempModule 必须使用与 AppModule 中一致的 LoggerModule 配置（LoggerModule.forRoot()）。
 * 2. 初始化时将 logger: false 禁用原生日志，避免日志输出与问题冲突。
 * 3. abortOnError: false 确保初始化异常不会导致应用直接崩溃，否则日志无法输出。
 */
async function createLogger(): Promise<Logger> {
  @Module({
    imports: [LoggerModule.forRoot()],
    // LoggerModule 配置需与 AppModule 保持一致，确保日志行为统一
  })
  class TempModule {}

  // 创建临时的 Nest 容器，仅用于实例化 Logger，不启动完整应用
  const tempApp = await NestFactory.createApplicationContext(TempModule, {
    // 禁用内建的日志系统，避免日志回退到内建方案
    logger: false,
    // 避免模块初始化失败时报错直接退出，便于捕捉日志输出
    abortOnError: false,
  });

  // 立即关闭临时容器，避免资源泄露
  await tempApp.close();

  // 获取已初始化的 Logger 实例
  return tempApp.get(Logger);
}

/**
 * 应用程序主入口函数，用于启动 NestJS Fastify 应用。
 *
 * @description 创建 NestJS 应用实例并调用引导函数完成应用初始化。
 * @returns {Promise<void>} 当应用成功启动时解析的 Promise。
 */
const main = async (): Promise<void> => {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter(),
    {
      logger: await createLogger(),
      bufferLogs: true,
    },
  );
  const configService = app.get(ConfigService);

  const cors = configService.get('CORS') === 'true';
  if (cors) {
    app.enableCors();
  }

const options = new DocumentBuilder()
    .setTitle('API')
    .setDescription('API docs')
    .setVersion('1.0')
    .addBearerAuth()
    .addGlobalParameters({
      in: 'header',
      required: false,
      name: process.env.APP_HEADER_LANGUAGE || 'x-custom-lang',
      schema: {
        example: 'en',
      },
    })
    .build();

  const document = SwaggerModule.createDocument(app, options);
  SwaggerModule.setup('docs', app, document);
  
  const port = configService.getOrThrow<number>('PORT');
  await app.listen(port || 3000);
  console.log(`Application is running on: ${await app.getUrl()}`);
};

/**
 * 调用主引导函数并处理错误。
 *
 * @description 执行主函数，捕获并记录启动过程中的任何错误，然后退出进程。
 * @returns {void}
 */
main().catch((error) => {
  console.log(error);
  process.exit(1);
});
